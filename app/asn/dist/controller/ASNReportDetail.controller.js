sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageBox"],function(e,t){"use strict";return e.extend("sap.fiori.asn.controller.ASNReportDetail",{onInit:function(){this._tableTemp=this.getView().byId("tableTempId").clone();this.detailModel=new sap.ui.model.json.JSONModel;this.detailModel.setSizeLimit(1e7);this.getView().setModel(this.detailModel,"detailModel");this.router=sap.ui.core.UIComponent.getRouterFor(this);this.router.attachRouteMatched(this.handleRouteMatched,this);this.byId("uploadSet").attachEvent("openPressed",this.onOpenPressed,this);this.byId("uploadSet").setUploadEnabled(false)},handleRouteMatched:function(e){if(e.getParameter("name")==="ASNReportDetail"){sap.ui.core.BusyIndicator.show();var s=this;this.LoggedUser=sessionStorage.getItem("LoggedUser")||"rajeshsehgal@impauto.com";var o=e.getParameter("arguments");this.AsnNumber=o.AsnNumber.replace(/-/g,"/");this.AsnNum=o.AsnNumber;this.getView().byId("pageId").setTitle("ASN Number - "+this.AsnNumber);var i=this.getOwnerComponent().getModel();var r=this.byId("uploadSet");r.removeAllItems();s.detailModel.setData([]);s.detailModel.refresh();i.read("/GetASNDetailList",{urlParameters:{username:this.LoggedUser,AddressCode:o.AddressCode,ASNNumber:this.AsnNumber,UnitCode:o.UnitCode},success:function(e){sap.ui.core.BusyIndicator.hide();s.detailModel.setData(e);s.detailModel.refresh();s._fetchFilesForPoNum(s.AsnNum)},error:function(e){sap.ui.core.BusyIndicator.hide();var s=JSON.parse(e.response.body);t.error(s.error.message.value)}})}},_fetchFilesForPoNum:function(e){var t=this;var s=this.getView().getModel("catalog");var o=this.byId("uploadSet");o.removeAllItems();s.read("/Files",{filters:[new sap.ui.model.Filter("AsnNum",sap.ui.model.FilterOperator.EQ,e)],success:function(e){e.results.forEach(function(e){var t=new sap.m.upload.UploadSetItem({fileName:e.fileName,mediaType:e.mediaType,url:e.url,attributes:[new sap.m.ObjectAttribute({title:"Uploaded By",text:e.createdBy}),new sap.m.ObjectAttribute({title:"Uploaded on",text:e.createdAt}),new sap.m.ObjectAttribute({title:"File Size",text:e.size.toString()})]});t.setVisibleEdit(false).setVisibleRemove(false);o.addItem(t)})},error:function(e){console.log("Error: "+e)}})},onOpenPressed:function(e){e.preventDefault();var t=e.getParameter("item");this._fileName=t.getFileName();this._download(t).then(e=>{var t=window.URL.createObjectURL(e);var s=document.createElement("a");s.href=t;s.setAttribute("download",this._fileName);document.body.appendChild(s);s.click();document.body.removeChild(s)}).catch(e=>{console.log(e)})},_download:function(e){console.log("_download");var t={url:e.getUrl(),method:"GET",xhrFields:{responseType:"blob"}};return new Promise((e,s)=>{$.ajax(t).done((t,s,o)=>{e(t)}).fail(e=>{s(e)})})},onNavPress:function(){history.go(-1)}})});